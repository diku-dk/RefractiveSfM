%POSE3DSOLVER_KNOWN_AXIS Refractive pose minimal solver, known rotation axis case
%	v = POSE3DSOLVER_KNOWN_AXIS(X,x,N,d,r) solves for the rotation and
%	translation parameters of a camera observing scene points X projected
%	to image points x through a refractive plane given by N'*W + d = 0. r
%	is the ratio n1/n2 where n1 and n2 are the refractive indices of the
%	camera- and point-side media respectively. If no extra parameters are
%	given, it is assumed that the known axis correpsonds to the y-axis in
%	both the scene and camera coordinate systems. The rotation is returned
%	as a unit-length quaternion Q s.t. v = [Q; tx; ty; tz];
%
%	v = POSE3DSOLVER_KNOWN_AXIS(...,'axis_scene',axis) gives the direction
%	of the known rotation axis in the scene coordinate system.
%
%	v = POSE3DSOLVER_KNOWN_AXIS(...,'axis_cam',axis) gives the direction of
%	the known rotation axis in the camera coordinate system.
%	
%	v = POSE3DSOLVER_KNOWN_AXIS(...,'newton',k) refines the solutions with
%	k Newton steps.
%
%	v = POSE3DSOLVER_KNOWN_AXIS(...,'check_tol',tol) filters solutions with
%	absolute tolerance tol.

%	This function calls the mex-file pose3dsolver_known_axis_helper which
%	can be compiled using 'mex pose3dsolver_known_axis_helper.cpp'. Note
%	that this may take a few minutes since the compiler needs to optimize
%	the automatically generated code.
function v = pose3dsolver_known_axis(X,x,N,d,r,varargin)

newton_steps = 0;
check_tol = 1e-3;
axis_scene = [];

for i=1:2:length(varargin)
	switch varargin{i}
		case 'newton', newton_steps = varargin{i+1};
		case 'check_tol', check_tol = varargin{i+1};
		case 'axis_scene', axis_scene = varargin{i+1};
		case 'axis_cam', axis_cam = varargin{i+1};
		otherwise, error('Parameter parse error');
	end
end

x = [x(1:2,:); ones(1,size(x,2))];
u = bsxfun(@rdivide,x,sqrt(sum(x.^2,1)));
nrat2 = r^2;

% Rotate scene coordinate system so that the rotation axis is aligned with
% the positive y-axis and the normal lies in the yz-plane. Choose the
% rotation such that N_z < 0. In most situations, and given that the normal
% is pointing away from the scene points (this is not checked for), this
% will minimize the likelihood of encountering the 180 degree singularity
% of the parametrization.
if ~isempty(axis_scene)
	[q r] = qr([axis_scene(:) N(:)]);
	R_s = q(:,[3 1 2]);
	R_s(:,2) = R_s(:,2)*sign(r(1,1));
	R_s(:,3) = -R_s(:,3)*sign(r(2,2));
	R_s(:,1) = R_s(:,1)*det(R_s);
	X = R_s'*X;
	N = R_s'*N;
	
	% Rotate camera coordinate system so that the known axis is aligned
	% with the positive y-axis
	[q r] = qr(axis_cam);
	R_c = q(:,[2 1 3]);
	R_c(:,2) = R_c(:,2)*sign(r(1,1));
	R_c(:,1) = R_c(:,1)*det(R_c);
	u = R_c'*u;
end
% R_s
% R_c
% N
% R_s'*axis_scene
% R_c'*axis_cam
% det(R_s), det(R_c)

% Fill in equation matrices. This step is way too slow in pure Matlab even with "optimized" generated code.
% Mex'ed version
coeff1 = pose3dsolver_known_axis_helper(u(:,1),X(:,1),N,d,nrat2);
coeff2 = pose3dsolver_known_axis_helper(u(:,2),X(:,2),N,d,nrat2);
A = eqmat([coeff1 coeff2]);


[v e] = polyeig(A{:});

good = ~(isinf(e) | isnan(e) | abs(v(1,:))'<1e-12);
e = e(good); v = v(:,good);
v = bsxfun(@rdivide,v([11 5 2],:),v(1,:));
v = [e.'; v];

% Throw away obviously complex solutions
v = real(v(:,max(abs(imag(v)))<1e-4));


% This does not (always) work.
% For angles larger than about 160 deg.
% the equations become so sensitive that
% any solutions in that range cannot be
% verified and might be missed.
% This should not be a problem if the coordinate
% system is rotated so that the plane
% normal lies in the yz-plane, making angles
% larger than 90 very rare.

% Check in the equations
keep = true(1,size(v,2));
for i=1:size(v,2)
	if max(abs(solvedeq(u,X,N,d,nrat2,v(:,i))))>check_tol
		keep(i) = false;
	end
end
v = v(:,keep);


% Take a few Newton steps to refine solutions
if newton_steps
	keep = true(1,size(v,2));
	for i=1:size(v,2)
		for j=1:newton_steps
			[f J] = eqjacandfun(u,X,N,d,nrat2,v(:,i));
			v(:,i) = v(:,i) - J\f;
		end
		if max(abs(solvedeq(u,X,N,d,nrat2,v(:,i))))>check_tol
			keep(i) = false;
		end
	end
	v = v(:,keep);
end

% Transform solution back to original coordinates
if ~isempty(axis_scene)
	vt = zeros(7,size(v,2));
	for i=1:size(v,2)
		theta = 2*atan(v(1,i));
		c = cos(theta); s = sin(theta);
		R_a = [c 0 -s; 0 1 0; s 0 c];
		vt(:,i) = [rot2quat(R_c*R_a*R_s'); R_s*v(2:4,i)];
	end
	v = vt;
end


function q = rot2quat(R)
q(4,1) = sqrt(max(0,1-R(1,1)-R(2,2)+R(3,3)))*sign(R(2,1)-R(1,2))/2;
q(3,1) = sqrt(max(0,1-R(1,1)+R(2,2)-R(3,3)))*sign(R(1,3)-R(3,1))/2;
q(2,1) = sqrt(max(0,1+R(1,1)-R(2,2)-R(3,3)))*sign(R(3,2)-R(2,3))/2;
q(1,1) = sqrt(max(0,1+R(1,1)+R(2,2)+R(3,3)))/2;


function A = eqmat(coef)

ind1 = [1 2 3 4 5 6 7 8 33 34 35 36 37 38 39 40 57 58 59 60 61 62 63 64 65 66 67 69 70 71 89 90 91 92 93 94 95 96 121 122 123 125 126 127 129 130 131 132 133 134 135 136 145 146 147 148 149 150 151 152 161 162 163 165 166 167 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 192 209 210 211 213 214 215 217 218 219 221 222 223 225 226 227 229 230 231 241 242 243 244 245 246 247 248 273 274 275 277 278 279 281 282 283 285 286 287 305 306 307 309 310 311 321 322 323 324 325 326 327 328 329 330 331 332 333 334 335 336 353 354 355 357 358 359 361 362 363 364 365 366 367 368 377 378 379 380 381 382 383 384 393 394 395 397 398 399 409 410 411 413 414 415 417 418 419 421 422 423 425 426 427 428 429 430 431 432 433 434 435 436 437 438 439 440 457 458 459 461 462 463 465 466 467 469 470 471 473 474 475 477 478 479 489 490 491 493 494 495 497 498 499 501 502 503 513 514 515 517 518 519 521 522 523 524 525 526 527 528 553 554 555 557 558 559 569 570 571 573 574 575 585 586 587 589 590 591 593 594 595 597 598 599 617 618 619 621 622 623];
ind2 = [1 2 3 5 6 7 33 34 35 37 38 39 57 58 59 61 62 63 65 66 67 69 70 71 89 90 91 93 94 95 121 122 123 125 126 127 129 130 131 133 134 135 145 146 147 149 150 151 161 162 163 165 166 167 177 178 179 181 182 183 185 186 187 189 190 191 209 210 211 213 214 215 217 218 219 221 222 223 225 226 227 229 230 231 241 242 243 245 246 247 273 274 275 277 278 279 281 282 283 285 286 287 305 306 307 309 310 311 321 322 323 325 326 327 329 330 331 333 334 335 353 354 355 357 358 359 361 362 363 365 366 367 377 378 379 381 382 383 393 394 395 397 398 399 409 410 411 413 414 415 417 418 419 421 422 423 425 426 427 429 430 431 433 434 435 437 438 439 457 458 459 461 462 463 465 466 467 469 470 471 473 474 475 477 478 479 489 490 491 493 494 495 497 498 499 501 502 503 513 514 515 517 518 519 521 522 523 525 526 527 553 554 555 557 558 559 569 570 571 573 574 575 585 586 587 589 590 591 593 594 595 597 598 599 617 618 619 621 622 623];
A = cell(9,1);
A{1} = [90 180 270 282 372 462 552 564 89 179 269 281 371 461 551 563 90 180 270 282 372 462 552 564 88 178 268 370 460 550 89 179 269 281 371 461 551 563 88 178 268 370 460 550 87 177 267 280 369 459 549 562 90 180 270 282 372 462 552 564 86 176 266 368 458 548 89 179 269 281 371 461 551 563 87 177 267 280 369 459 549 562 88 178 268 370 460 550 86 176 266 368 458 548 85 175 265 367 457 547 87 177 267 280 369 459 549 562 86 176 266 368 458 548 85 175 265 367 457 547 85 175 265 367 457 547 84 174 264 279 366 456 546 561 90 180 270 282 372 462 552 564 83 173 263 365 455 545 89 179 269 281 371 461 551 563 84 174 264 279 366 456 546 561 88 178 268 370 460 550 83 173 263 365 455 545 82 172 262 364 454 544 87 177 267 280 369 459 549 562 84 174 264 279 366 456 546 561 86 176 266 368 458 548 83 173 263 365 455 545 82 172 262 364 454 544 85 175 265 367 457 547 82 172 262 364 454 544 81 171 261 363 453 543 84 174 264 279 366 456 546 561 83 173 263 365 455 545 81 171 261 363 453 543 82 172 262 364 454 544 81 171 261 363 453 543 81 171 261 363 453 543];
A{2} = [80 170 260 278 362 452 542 560 79 169 259 277 361 451 541 559 80 170 260 278 362 452 542 560 78 168 258 360 450 540 79 169 259 277 361 451 541 559 78 168 258 360 450 540 77 167 257 276 359 449 539 558 80 170 260 278 362 452 542 560 76 166 256 358 448 538 79 169 259 277 361 451 541 559 77 167 257 276 359 449 539 558 78 168 258 360 450 540 76 166 256 358 448 538 75 165 255 357 447 537 77 167 257 276 359 449 539 558 76 166 256 358 448 538 75 165 255 357 447 537 75 165 255 357 447 537 74 164 254 275 356 446 536 557 80 170 260 278 362 452 542 560 73 163 253 355 445 535 79 169 259 277 361 451 541 559 74 164 254 275 356 446 536 557 78 168 258 360 450 540 73 163 253 355 445 535 72 162 252 354 444 534 77 167 257 276 359 449 539 558 74 164 254 275 356 446 536 557 76 166 256 358 448 538 73 163 253 355 445 535 72 162 252 354 444 534 75 165 255 357 447 537 72 162 252 354 444 534 71 161 251 353 443 533 74 164 254 275 356 446 536 557 73 163 253 355 445 535 71 161 251 353 443 533 72 162 252 354 444 534 71 161 251 353 443 533 71 161 251 353 443 533];
A{3} = [70 160 250 274 352 442 532 556 69 159 249 273 351 441 531 555 70 160 250 274 352 442 532 556 68 158 248 350 440 530 69 159 249 273 351 441 531 555 68 158 248 350 440 530 67 157 247 272 349 439 529 554 70 160 250 274 352 442 532 556 66 156 246 348 438 528 69 159 249 273 351 441 531 555 67 157 247 272 349 439 529 554 68 158 248 350 440 530 66 156 246 348 438 528 65 155 245 347 437 527 67 157 247 272 349 439 529 554 66 156 246 348 438 528 65 155 245 347 437 527 65 155 245 347 437 527 64 154 244 271 346 436 526 553 70 160 250 274 352 442 532 556 63 153 243 345 435 525 69 159 249 273 351 441 531 555 64 154 244 271 346 436 526 553 68 158 248 350 440 530 63 153 243 345 435 525 62 152 242 344 434 524 67 157 247 272 349 439 529 554 64 154 244 271 346 436 526 553 66 156 246 348 438 528 63 153 243 345 435 525 62 152 242 344 434 524 65 155 245 347 437 527 62 152 242 344 434 524 61 151 241 343 433 523 64 154 244 271 346 436 526 553 63 153 243 345 435 525 61 151 241 343 433 523 62 152 242 344 434 524 61 151 241 343 433 523 61 151 241 343 433 523];
A{4} = [60 150 240 342 432 522 59 149 239 341 431 521 60 150 240 342 432 522 58 148 238 340 430 520 59 149 239 341 431 521 58 148 238 340 430 520 57 147 237 339 429 519 60 150 240 342 432 522 56 146 236 338 428 518 59 149 239 341 431 521 57 147 237 339 429 519 58 148 238 340 430 520 56 146 236 338 428 518 55 145 235 337 427 517 57 147 237 339 429 519 56 146 236 338 428 518 55 145 235 337 427 517 55 145 235 337 427 517 54 144 234 336 426 516 60 150 240 342 432 522 53 143 233 335 425 515 59 149 239 341 431 521 54 144 234 336 426 516 58 148 238 340 430 520 53 143 233 335 425 515 52 142 232 334 424 514 57 147 237 339 429 519 54 144 234 336 426 516 56 146 236 338 428 518 53 143 233 335 425 515 52 142 232 334 424 514 55 145 235 337 427 517 52 142 232 334 424 514 51 141 231 333 423 513 54 144 234 336 426 516 53 143 233 335 425 515 51 141 231 333 423 513 52 142 232 334 424 514 51 141 231 333 423 513 51 141 231 333 423 513];
A{5} = [50 140 230 332 422 512 49 139 229 331 421 511 50 140 230 332 422 512 48 138 228 330 420 510 49 139 229 331 421 511 48 138 228 330 420 510 47 137 227 329 419 509 50 140 230 332 422 512 46 136 226 328 418 508 49 139 229 331 421 511 47 137 227 329 419 509 48 138 228 330 420 510 46 136 226 328 418 508 45 135 225 327 417 507 47 137 227 329 419 509 46 136 226 328 418 508 45 135 225 327 417 507 45 135 225 327 417 507 44 134 224 326 416 506 50 140 230 332 422 512 43 133 223 325 415 505 49 139 229 331 421 511 44 134 224 326 416 506 48 138 228 330 420 510 43 133 223 325 415 505 42 132 222 324 414 504 47 137 227 329 419 509 44 134 224 326 416 506 46 136 226 328 418 508 43 133 223 325 415 505 42 132 222 324 414 504 45 135 225 327 417 507 42 132 222 324 414 504 41 131 221 323 413 503 44 134 224 326 416 506 43 133 223 325 415 505 41 131 221 323 413 503 42 132 222 324 414 504 41 131 221 323 413 503 41 131 221 323 413 503];
A{6} = [40 130 220 322 412 502 39 129 219 321 411 501 40 130 220 322 412 502 38 128 218 320 410 500 39 129 219 321 411 501 38 128 218 320 410 500 37 127 217 319 409 499 40 130 220 322 412 502 36 126 216 318 408 498 39 129 219 321 411 501 37 127 217 319 409 499 38 128 218 320 410 500 36 126 216 318 408 498 35 125 215 317 407 497 37 127 217 319 409 499 36 126 216 318 408 498 35 125 215 317 407 497 35 125 215 317 407 497 34 124 214 316 406 496 40 130 220 322 412 502 33 123 213 315 405 495 39 129 219 321 411 501 34 124 214 316 406 496 38 128 218 320 410 500 33 123 213 315 405 495 32 122 212 314 404 494 37 127 217 319 409 499 34 124 214 316 406 496 36 126 216 318 408 498 33 123 213 315 405 495 32 122 212 314 404 494 35 125 215 317 407 497 32 122 212 314 404 494 31 121 211 313 403 493 34 124 214 316 406 496 33 123 213 315 405 495 31 121 211 313 403 493 32 122 212 314 404 494 31 121 211 313 403 493 31 121 211 313 403 493];
A{7} = [30 120 210 312 402 492 29 119 209 311 401 491 30 120 210 312 402 492 28 118 208 310 400 490 29 119 209 311 401 491 28 118 208 310 400 490 27 117 207 309 399 489 30 120 210 312 402 492 26 116 206 308 398 488 29 119 209 311 401 491 27 117 207 309 399 489 28 118 208 310 400 490 26 116 206 308 398 488 25 115 205 307 397 487 27 117 207 309 399 489 26 116 206 308 398 488 25 115 205 307 397 487 25 115 205 307 397 487 24 114 204 306 396 486 30 120 210 312 402 492 23 113 203 305 395 485 29 119 209 311 401 491 24 114 204 306 396 486 28 118 208 310 400 490 23 113 203 305 395 485 22 112 202 304 394 484 27 117 207 309 399 489 24 114 204 306 396 486 26 116 206 308 398 488 23 113 203 305 395 485 22 112 202 304 394 484 25 115 205 307 397 487 22 112 202 304 394 484 21 111 201 303 393 483 24 114 204 306 396 486 23 113 203 305 395 485 21 111 201 303 393 483 22 112 202 304 394 484 21 111 201 303 393 483 21 111 201 303 393 483];
A{8} = [20 110 200 302 392 482 19 109 199 301 391 481 20 110 200 302 392 482 18 108 198 300 390 480 19 109 199 301 391 481 18 108 198 300 390 480 17 107 197 299 389 479 20 110 200 302 392 482 16 106 196 298 388 478 19 109 199 301 391 481 17 107 197 299 389 479 18 108 198 300 390 480 16 106 196 298 388 478 15 105 195 297 387 477 17 107 197 299 389 479 16 106 196 298 388 478 15 105 195 297 387 477 15 105 195 297 387 477 14 104 194 296 386 476 20 110 200 302 392 482 13 103 193 295 385 475 19 109 199 301 391 481 14 104 194 296 386 476 18 108 198 300 390 480 13 103 193 295 385 475 12 102 192 294 384 474 17 107 197 299 389 479 14 104 194 296 386 476 16 106 196 298 388 478 13 103 193 295 385 475 12 102 192 294 384 474 15 105 195 297 387 477 12 102 192 294 384 474 11 101 191 293 383 473 14 104 194 296 386 476 13 103 193 295 385 475 11 101 191 293 383 473 12 102 192 294 384 474 11 101 191 293 383 473 11 101 191 293 383 473];
A{9} = [10 100 190 292 382 472 9 99 189 291 381 471 10 100 190 292 382 472 8 98 188 290 380 470 9 99 189 291 381 471 8 98 188 290 380 470 7 97 187 289 379 469 10 100 190 292 382 472 6 96 186 288 378 468 9 99 189 291 381 471 7 97 187 289 379 469 8 98 188 290 380 470 6 96 186 288 378 468 5 95 185 287 377 467 7 97 187 289 379 469 6 96 186 288 378 468 5 95 185 287 377 467 5 95 185 287 377 467 4 94 184 286 376 466 10 100 190 292 382 472 3 93 183 285 375 465 9 99 189 291 381 471 4 94 184 286 376 466 8 98 188 290 380 470 3 93 183 285 375 465 2 92 182 284 374 464 7 97 187 289 379 469 4 94 184 286 376 466 6 96 186 288 378 468 3 93 183 285 375 465 2 92 182 284 374 464 5 95 185 287 377 467 2 92 182 284 374 464 1 91 181 283 373 463 4 94 184 286 376 466 3 93 183 285 375 465 1 91 181 283 373 463 2 92 182 284 374 464 1 91 181 283 373 463 1 91 181 283 373 463];
for i=1:3
	M = zeros(32,20);
	M(ind1) = coef(A{i});
	A{i} = M;
end
for i=4:9
	M = zeros(32,20);
	M(ind2) = coef(A{i});
	A{i} = M;
end
R = A{2};
for i=1:9
	A{i} = R'*A{i};
end



function A0 = solvedeq(u,X,N,d,r2,v)

u11 = u(1,1); u21 = u(2,1); u31 = u(3,1);
u12 = u(1,2); u22 = u(2,2); u32 = u(3,2);
X11 = X(1,1); X21 = X(2,1); X31 = X(3,1);
X12 = X(1,2); X22 = X(2,2); X32 = X(3,2);
N1 = N(1); N2 = N(2); N3 = N(3);
q = v(1); tx = v(2); ty = v(3); tz = v(4);

A0 = zeros(8,1);

t2 = q*q;
t3 = t2+1.0;
t6 = d*u21;
t7 = d*t2*u21;
t8 = N1*X21*u11;
t9 = N2*X21*u21;
t10 = N3*X21*u31;
t11 = N1*tx*u21;
t12 = N1*ty*u11;
t13 = N3*ty*u31;
t14 = N3*tz*u21;
t15 = N3*q*ty*u11*2.0;
t16 = N1*q*ty*u31*2.0;
t17 = N1*X21*t2*u11;
t18 = N2*X21*t2*u21;
t19 = N3*X21*t2*u31;
t20 = N1*t2*tx*u21;
t21 = N1*t2*ty*u11;
t22 = N3*t2*ty*u31;
t23 = N3*t2*tz*u21;
t24 = N3*X21*q*u11*2.0;
t25 = N1*X21*q*u31*2.0;
t26 = t6+t7+t8+t9+t10+t11-t12-t13+t14+t15-t16-t17+t18-t19+t20+t21+t22+t23-t24+t25;
t28 = d*u31;
t29 = d*t2*u31;
t30 = N1*X31*u11;
t31 = N2*X31*u21;
t32 = N3*X31*u31;
t33 = N1*tx*u31;
t34 = N2*ty*u31;
t35 = N1*tz*u11;
t36 = N2*tz*u21;
t37 = d*q*u11*2.0;
t38 = N1*q*tx*u11*2.0;
t39 = N2*q*ty*u11*2.0;
t40 = N1*q*tz*u31*2.0;
t41 = N1*X31*t2*u11;
t42 = N2*X31*t2*u21;
t43 = N3*X31*t2*u31;
t44 = N1*t2*tx*u31;
t45 = N2*t2*ty*u31;
t46 = N1*t2*tz*u11;
t47 = N2*t2*tz*u21;
t48 = N3*X31*q*u11*2.0;
t49 = N1*X31*q*u31*2.0;
t50 = -t28+t29-t30-t31-t32-t33-t34+t35+t36+t37+t38+t39+t40+t41-t42+t43+t44+t45-t46+t47+t48-t49;
t4 = N3*t3*t26+N2*t3*t50;
t74 = t2-1.0;
t75 = t74*u31;
t76 = q*u11*2.0;
t77 = t75+t76;
t5 = N2*t77+N3*t3*u21;
t51 = d*u11;
t52 = d*t2*u11;
t53 = N1*X11*u11;
t54 = N2*X11*u21;
t55 = N3*X11*u31;
t56 = N2*tx*u21;
t57 = N3*tx*u31;
t58 = N2*ty*u11;
t59 = N3*tz*u11;
t60 = d*q*u31*2.0;
t61 = N3*q*tx*u11*2.0;
t62 = N2*q*ty*u31*2.0;
t63 = N3*q*tz*u31*2.0;
t64 = N1*X11*t2*u11;
t65 = N2*X11*t2*u21;
t66 = N3*X11*t2*u31;
t67 = N2*t2*tx*u21;
t68 = N3*t2*tx*u31;
t69 = N2*t2*ty*u11;
t70 = N3*t2*tz*u11;
t71 = N3*X11*q*u11*2.0;
t72 = N1*X11*q*u31*2.0;
t27 = t51-t52+t53+t54+t55-t56-t57+t58+t59+t60+t61+t62+t63-t64+t65-t66-t67+t68-t69-t70-t71+t72;
t73 = N3*t3*t27+N1*t3*t50;
t84 = t74*u11;
t85 = q*u31*2.0;
t86 = t84-t85;
t78 = N1*t77-N3*t86;
t79 = t26*t26;
t80 = t27*t27;
t81 = t50*t50;
t82 = t79+t80+t81;
t83 = N1*t3*t26-N2*t3*t27;
t87 = N2*t86+N1*t3*u21;
t90 = d*u22;
t91 = d*t2*u22;
t92 = N1*X22*u12;
t93 = N2*X22*u22;
t94 = N3*X22*u32;
t95 = N1*tx*u22;
t96 = N1*ty*u12;
t97 = N3*ty*u32;
t98 = N3*tz*u22;
t99 = N3*q*ty*u12*2.0;
t100 = N1*q*ty*u32*2.0;
t101 = N1*X22*t2*u12;
t102 = N2*X22*t2*u22;
t103 = N3*X22*t2*u32;
t104 = N1*t2*tx*u22;
t105 = N1*t2*ty*u12;
t106 = N3*t2*ty*u32;
t107 = N3*t2*tz*u22;
t108 = N3*X22*q*u12*2.0;
t109 = N1*X22*q*u32*2.0;
t110 = t90+t91+t92+t93+t94+t95-t96-t97+t98+t99-t100-t101+t102-t103+t104+t105+t106+t107-t108+t109;
t112 = d*u32;
t113 = d*t2*u32;
t114 = N1*X32*u12;
t115 = N2*X32*u22;
t116 = N3*X32*u32;
t117 = N1*tx*u32;
t118 = N2*ty*u32;
t119 = N1*tz*u12;
t120 = N2*tz*u22;
t121 = d*q*u12*2.0;
t122 = N1*q*tx*u12*2.0;
t123 = N2*q*ty*u12*2.0;
t124 = N1*q*tz*u32*2.0;
t125 = N1*X32*t2*u12;
t126 = N2*X32*t2*u22;
t127 = N3*X32*t2*u32;
t128 = N1*t2*tx*u32;
t129 = N2*t2*ty*u32;
t130 = N1*t2*tz*u12;
t131 = N2*t2*tz*u22;
t132 = N3*X32*q*u12*2.0;
t133 = N1*X32*q*u32*2.0;
t134 = -t112+t113-t114-t115-t116-t117-t118+t119+t120+t121+t122+t123+t124+t125-t126+t127+t128+t129-t130+t131+t132-t133;
t88 = N3*t3*t110+N2*t3*t134;
t158 = t74*u32;
t159 = q*u12*2.0;
t160 = t158+t159;
t89 = N2*t160+N3*t3*u22;
t135 = d*u12;
t136 = d*t2*u12;
t137 = N1*X12*u12;
t138 = N2*X12*u22;
t139 = N3*X12*u32;
t140 = N2*tx*u22;
t141 = N3*tx*u32;
t142 = N2*ty*u12;
t143 = N3*tz*u12;
t144 = d*q*u32*2.0;
t145 = N3*q*tx*u12*2.0;
t146 = N2*q*ty*u32*2.0;
t147 = N3*q*tz*u32*2.0;
t148 = N1*X12*t2*u12;
t149 = N2*X12*t2*u22;
t150 = N3*X12*t2*u32;
t151 = N2*t2*tx*u22;
t152 = N3*t2*tx*u32;
t153 = N2*t2*ty*u12;
t154 = N3*t2*tz*u12;
t155 = N3*X12*q*u12*2.0;
t156 = N1*X12*q*u32*2.0;
t111 = t135-t136+t137+t138+t139-t140-t141+t142+t143+t144+t145+t146+t147-t148+t149-t150-t151+t152-t153-t154-t155+t156;
t157 = N3*t3*t111+N1*t3*t134;
t167 = t74*u12;
t168 = q*u32*2.0;
t169 = t167-t168;
t161 = N1*t160-N3*t169;
t162 = t110*t110;
t163 = t111*t111;
t164 = t134*t134;
t165 = t162+t163+t164;
t166 = N1*t3*t110-N2*t3*t111;
t170 = N2*t169+N1*t3*u22;
A0(1,1) = -t4*t4+r2*(t5*t5)*t82;
A0(2,1) = -t73*t73+r2*(t78*t78)*t82;
A0(3,1) = -t83*t83+r2*t82*(t87*t87);
A0(4,1) = N3*X11*u21-N3*X21*u11-N2*X11*u31+N2*X31*u11+N1*X21*u31-N1*X31*u21-N3*tx*u21+N2*tx*u31+N3*ty*u11-N1*ty*u31-N2*tz*u11+N1*tz*u21-N2*q*tx*u11*2.0+N1*q*ty*u11*2.0+N3*q*ty*u31*2.0-N2*q*tz*u31*2.0-N3*t2*tx*u21-N2*t2*tx*u31-N3*t2*ty*u11+N1*t2*ty*u31+N2*t2*tz*u11+N1*t2*tz*u21+N2*X11*q*u11*2.0-N1*X21*q*u11*2.0-N3*X21*q*u31*2.0+N2*X31*q*u31*2.0+N3*X11*t2*u21+N3*X21*t2*u11+N2*X11*t2*u31-N2*X31*t2*u11-N1*X21*t2*u31-N1*X31*t2*u21;
A0(5,1) = -t88*t88+r2*(t89*t89)*t165;
A0(6,1) = -t157*t157+r2*(t161*t161)*t165;
A0(7,1) = -t166*t166+r2*t165*(t170*t170);
A0(8,1) = N3*X12*u22-N3*X22*u12-N2*X12*u32+N2*X32*u12+N1*X22*u32-N1*X32*u22-N3*tx*u22+N2*tx*u32+N3*ty*u12-N1*ty*u32-N2*tz*u12+N1*tz*u22-N2*q*tx*u12*2.0+N1*q*ty*u12*2.0+N3*q*ty*u32*2.0-N2*q*tz*u32*2.0-N3*t2*tx*u22-N2*t2*tx*u32-N3*t2*ty*u12+N1*t2*ty*u32+N2*t2*tz*u12+N1*t2*tz*u22+N2*X12*q*u12*2.0-N1*X22*q*u12*2.0-N3*X22*q*u32*2.0+N2*X32*q*u32*2.0+N3*X12*t2*u22+N3*X22*t2*u12+N2*X12*t2*u32-N2*X32*t2*u12-N1*X22*t2*u32-N1*X32*t2*u22;



function [f J] = eqjacandfun(u,X,N,d,r2,v)

u11 = u(1,1); u21 = u(2,1); u31 = u(3,1);
u12 = u(1,2); u22 = u(2,2); u32 = u(3,2);
X11 = X(1,1); X21 = X(2,1); X31 = X(3,1);
X12 = X(1,2); X22 = X(2,2); X32 = X(3,2);
N1 = N(1); N2 = N(2); N3 = N(3);
q = v(1); tx = v(2); ty = v(3); tz = v(4);

f = zeros(8,1);
J = zeros(8,4);


t2 = q*q;
t3 = t2+1.0;
t6 = d*u21;
t7 = d*t2*u21;
t8 = N1*X21*u11;
t9 = N2*X21*u21;
t10 = N3*X21*u31;
t11 = N1*tx*u21;
t12 = N1*ty*u11;
t13 = N3*ty*u31;
t14 = N3*tz*u21;
t15 = N3*q*ty*u11*2.0;
t16 = N1*q*ty*u31*2.0;
t17 = N1*X21*t2*u11;
t18 = N2*X21*t2*u21;
t19 = N3*X21*t2*u31;
t20 = N1*t2*tx*u21;
t21 = N1*t2*ty*u11;
t22 = N3*t2*ty*u31;
t23 = N3*t2*tz*u21;
t24 = N3*X21*q*u11*2.0;
t25 = N1*X21*q*u31*2.0;
t26 = t6+t7+t8+t9+t10+t11-t12-t13+t14+t15-t16-t17+t18-t19+t20+t21+t22+t23-t24+t25;
t28 = d*u31;
t29 = d*t2*u31;
t30 = N1*X31*u11;
t31 = N2*X31*u21;
t32 = N3*X31*u31;
t33 = N1*tx*u31;
t34 = N2*ty*u31;
t35 = N1*tz*u11;
t36 = N2*tz*u21;
t37 = d*q*u11*2.0;
t38 = N1*q*tx*u11*2.0;
t39 = N2*q*ty*u11*2.0;
t40 = N1*q*tz*u31*2.0;
t41 = N1*X31*t2*u11;
t42 = N2*X31*t2*u21;
t43 = N3*X31*t2*u31;
t44 = N1*t2*tx*u31;
t45 = N2*t2*ty*u31;
t46 = N1*t2*tz*u11;
t47 = N2*t2*tz*u21;
t48 = N3*X31*q*u11*2.0;
t49 = N1*X31*q*u31*2.0;
t50 = -t28+t29-t30-t31-t32-t33-t34+t35+t36+t37+t38+t39+t40+t41-t42+t43+t44+t45-t46+t47+t48-t49;
t171 = N2*t3*t50;
t172 = N3*t3*t26;
t4 = t171+t172;
t74 = t2-1.0;
t75 = t74*u31;
t76 = q*u11*2.0;
t77 = t75+t76;
t175 = N2*t77;
t176 = N3*t3*u21;
t5 = t175+t176;
t51 = d*u11;
t52 = d*t2*u11;
t53 = N1*X11*u11;
t54 = N2*X11*u21;
t55 = N3*X11*u31;
t56 = N2*tx*u21;
t57 = N3*tx*u31;
t58 = N2*ty*u11;
t59 = N3*tz*u11;
t60 = d*q*u31*2.0;
t61 = N3*q*tx*u11*2.0;
t62 = N2*q*ty*u31*2.0;
t63 = N3*q*tz*u31*2.0;
t64 = N1*X11*t2*u11;
t65 = N2*X11*t2*u21;
t66 = N3*X11*t2*u31;
t67 = N2*t2*tx*u21;
t68 = N3*t2*tx*u31;
t69 = N2*t2*ty*u11;
t70 = N3*t2*tz*u11;
t71 = N3*X11*q*u11*2.0;
t72 = N1*X11*q*u31*2.0;
t27 = t51-t52+t53+t54+t55-t56-t57+t58+t59+t60+t61+t62+t63-t64+t65-t66-t67+t68-t69-t70-t71+t72;
t195 = N3*t3*t27;
t196 = N1*t3*t50;
t73 = t195+t196;
t84 = t74*u11;
t85 = q*u31*2.0;
t86 = t84-t85;
t206 = N1*t77;
t207 = N3*t86;
t78 = t206-t207;
t79 = t26*t26;
t80 = t27*t27;
t81 = t50*t50;
t82 = t79+t80+t81;
t225 = N2*t3*t27;
t226 = N1*t3*t26;
t83 = -t225+t226;
t227 = N2*t86;
t228 = N1*t3*u21;
t87 = t227+t228;
t90 = d*u22;
t91 = d*t2*u22;
t92 = N1*X22*u12;
t93 = N2*X22*u22;
t94 = N3*X22*u32;
t95 = N1*tx*u22;
t96 = N1*ty*u12;
t97 = N3*ty*u32;
t98 = N3*tz*u22;
t99 = N3*q*ty*u12*2.0;
t100 = N1*q*ty*u32*2.0;
t101 = N1*X22*t2*u12;
t102 = N2*X22*t2*u22;
t103 = N3*X22*t2*u32;
t104 = N1*t2*tx*u22;
t105 = N1*t2*ty*u12;
t106 = N3*t2*ty*u32;
t107 = N3*t2*tz*u22;
t108 = N3*X22*q*u12*2.0;
t109 = N1*X22*q*u32*2.0;
t110 = t90+t91+t92+t93+t94+t95-t96-t97+t98+t99-t100-t101+t102-t103+t104+t105+t106+t107-t108+t109;
t112 = d*u32;
t113 = d*t2*u32;
t114 = N1*X32*u12;
t115 = N2*X32*u22;
t116 = N3*X32*u32;
t117 = N1*tx*u32;
t118 = N2*ty*u32;
t119 = N1*tz*u12;
t120 = N2*tz*u22;
t121 = d*q*u12*2.0;
t122 = N1*q*tx*u12*2.0;
t123 = N2*q*ty*u12*2.0;
t124 = N1*q*tz*u32*2.0;
t125 = N1*X32*t2*u12;
t126 = N2*X32*t2*u22;
t127 = N3*X32*t2*u32;
t128 = N1*t2*tx*u32;
t129 = N2*t2*ty*u32;
t130 = N1*t2*tz*u12;
t131 = N2*t2*tz*u22;
t132 = N3*X32*q*u12*2.0;
t133 = N1*X32*q*u32*2.0;
t134 = -t112+t113-t114-t115-t116-t117-t118+t119+t120+t121+t122+t123+t124+t125-t126+t127+t128+t129-t130+t131+t132-t133;
t232 = N2*t3*t134;
t233 = N3*t3*t110;
t88 = t232+t233;
t158 = t74*u32;
t159 = q*u12*2.0;
t160 = t158+t159;
t236 = N2*t160;
t237 = N3*t3*u22;
t89 = t236+t237;
t135 = d*u12;
t136 = d*t2*u12;
t137 = N1*X12*u12;
t138 = N2*X12*u22;
t139 = N3*X12*u32;
t140 = N2*tx*u22;
t141 = N3*tx*u32;
t142 = N2*ty*u12;
t143 = N3*tz*u12;
t144 = d*q*u32*2.0;
t145 = N3*q*tx*u12*2.0;
t146 = N2*q*ty*u32*2.0;
t147 = N3*q*tz*u32*2.0;
t148 = N1*X12*t2*u12;
t149 = N2*X12*t2*u22;
t150 = N3*X12*t2*u32;
t151 = N2*t2*tx*u22;
t152 = N3*t2*tx*u32;
t153 = N2*t2*ty*u12;
t154 = N3*t2*tz*u12;
t155 = N3*X12*q*u12*2.0;
t156 = N1*X12*q*u32*2.0;
t111 = t135-t136+t137+t138+t139-t140-t141+t142+t143+t144+t145+t146+t147-t148+t149-t150-t151+t152-t153-t154-t155+t156;
t256 = N3*t3*t111;
t257 = N1*t3*t134;
t157 = t256+t257;
t167 = t74*u12;
t168 = q*u32*2.0;
t169 = t167-t168;
t267 = N1*t160;
t268 = N3*t169;
t161 = t267-t268;
t162 = t110*t110;
t163 = t111*t111;
t164 = t134*t134;
t165 = t162+t163+t164;
t286 = N2*t3*t111;
t287 = N1*t3*t110;
t166 = -t286+t287;
t288 = N2*t169;
t289 = N1*t3*u22;
t170 = t288+t289;
t173 = N1*q*ty*u11*2.0;
t174 = N3*q*ty*u31*2.0;
t177 = t5*t5;
t178 = N1*X21*u31*2.0;
t179 = N3*ty*u11*2.0;
t180 = d*q*u21*2.0;
t181 = N1*q*tx*u21*2.0;
t182 = N3*q*tz*u21*2.0;
t183 = N2*X21*q*u21*2.0;
t209 = N3*X21*u11*2.0;
t210 = N1*ty*u31*2.0;
t211 = N1*X21*q*u11*2.0;
t212 = N3*X21*q*u31*2.0;
t184 = t173+t174+t178+t179+t180+t181+t182+t183-t209-t210-t211-t212;
t185 = d*u11*2.0;
t186 = N3*X31*u11*2.0;
t187 = N1*tx*u11*2.0;
t188 = N2*ty*u11*2.0;
t189 = N1*tz*u31*2.0;
t190 = N1*q*tx*u31*2.0;
t191 = N2*q*tz*u21*2.0;
t192 = N1*X31*q*u11*2.0;
t193 = N3*X31*q*u31*2.0;
t203 = N1*X31*u31*2.0;
t204 = N1*q*tz*u11*2.0;
t205 = N2*X31*q*u21*2.0;
t194 = t60+t62+t185+t186+t187+t188+t189+t190+t191+t192+t193-t203-t204-t205;
t197 = N3*X11*u11*2.0;
t198 = N2*q*tx*u21*2.0;
t199 = N3*q*tz*u11*2.0;
t200 = N1*X11*q*u11*2.0;
t201 = N3*X11*q*u31*2.0;
t214 = d*u31*2.0;
t215 = N1*X11*u31*2.0;
t216 = N3*tx*u11*2.0;
t217 = N2*ty*u31*2.0;
t218 = N3*tz*u31*2.0;
t219 = N3*q*tx*u31*2.0;
t220 = N2*X11*q*u21*2.0;
t202 = t37+t39+t197+t198+t199+t200+t201-t214-t215-t216-t217-t218-t219-t220;
t208 = t78*t78;
t213 = t26*t184*2.0;
t221 = t50*t194*2.0;
t230 = t27*t202*2.0;
t222 = t213+t221-t230;
t223 = u11*2.0;
t224 = t85+t223;
t229 = t87*t87;
t231 = t76-u31*2.0;
t234 = N1*q*ty*u12*2.0;
t235 = N3*q*ty*u32*2.0;
t238 = t89*t89;
t239 = N1*X22*u32*2.0;
t240 = N3*ty*u12*2.0;
t241 = d*q*u22*2.0;
t242 = N1*q*tx*u22*2.0;
t243 = N3*q*tz*u22*2.0;
t244 = N2*X22*q*u22*2.0;
t270 = N3*X22*u12*2.0;
t271 = N1*ty*u32*2.0;
t272 = N1*X22*q*u12*2.0;
t273 = N3*X22*q*u32*2.0;
t245 = t234+t235+t239+t240+t241+t242+t243+t244-t270-t271-t272-t273;
t246 = d*u12*2.0;
t247 = N3*X32*u12*2.0;
t248 = N1*tx*u12*2.0;
t249 = N2*ty*u12*2.0;
t250 = N1*tz*u32*2.0;
t251 = N1*q*tx*u32*2.0;
t252 = N2*q*tz*u22*2.0;
t253 = N1*X32*q*u12*2.0;
t254 = N3*X32*q*u32*2.0;
t264 = N1*X32*u32*2.0;
t265 = N1*q*tz*u12*2.0;
t266 = N2*X32*q*u22*2.0;
t255 = t144+t146+t246+t247+t248+t249+t250+t251+t252+t253+t254-t264-t265-t266;
t258 = N3*X12*u12*2.0;
t259 = N2*q*tx*u22*2.0;
t260 = N3*q*tz*u12*2.0;
t261 = N1*X12*q*u12*2.0;
t262 = N3*X12*q*u32*2.0;
t275 = d*u32*2.0;
t276 = N1*X12*u32*2.0;
t277 = N3*tx*u12*2.0;
t278 = N2*ty*u32*2.0;
t279 = N3*tz*u32*2.0;
t280 = N3*q*tx*u32*2.0;
t281 = N2*X12*q*u22*2.0;
t263 = t121+t123+t258+t259+t260+t261+t262-t275-t276-t277-t278-t279-t280-t281;
t269 = t161*t161;
t274 = t110*t245*2.0;
t282 = t134*t255*2.0;
t291 = t111*t263*2.0;
t283 = t274+t282-t291;
t284 = u12*2.0;
t285 = t168+t284;
t290 = t170*t170;
t292 = t159-u32*2.0;
t293 = N1*u21;
t294 = N1*t2*u21;
t295 = t293+t294;
t296 = N1*q*u11*2.0;
t297 = N1*t2*u31;
t299 = N1*u31;
t298 = t296+t297-t299;
t300 = N2*u21;
t301 = N3*u31;
t302 = N2*t2*u21;
t306 = N3*q*u11*2.0;
t307 = N3*t2*u31;
t303 = t300+t301+t302-t306-t307;
t304 = t26*t295*2.0;
t305 = t50*t298*2.0;
t310 = t27*t303*2.0;
t308 = t304+t305-t310;
t309 = t225-t226;
t311 = N1*u22;
t312 = N1*t2*u22;
t313 = t311+t312;
t314 = N1*q*u12*2.0;
t315 = N1*t2*u32;
t317 = N1*u32;
t316 = t314+t315-t317;
t318 = N2*u22;
t319 = N3*u32;
t320 = N2*t2*u22;
t324 = N3*q*u12*2.0;
t325 = N3*t2*u32;
t321 = t318+t319+t320-t324-t325;
t322 = t110*t313*2.0;
t323 = t134*t316*2.0;
t328 = t111*t321*2.0;
t326 = t322+t323-t328;
t327 = t286-t287;
t329 = N2*u31;
t330 = N1*u11;
t331 = N1*q*u31*2.0;
t339 = N1*t2*u11;
t332 = t301-t306-t307+t330+t331-t339;
t333 = N2*q*u11*2.0;
t334 = N2*t2*u31;
t335 = -t329+t333+t334;
t336 = N2*u11;
t337 = N2*q*u31*2.0;
t340 = N2*t2*u11;
t338 = t336+t337-t340;
t341 = t27*t338*2.0;
t342 = t50*t335*2.0;
t344 = t26*t332*2.0;
t343 = t341+t342-t344;
t345 = N2*u32;
t346 = N1*u12;
t347 = N1*q*u32*2.0;
t355 = N1*t2*u12;
t348 = t319-t324-t325+t346+t347-t355;
t349 = N2*q*u12*2.0;
t350 = N2*t2*u32;
t351 = -t345+t349+t350;
t352 = N2*u12;
t353 = N2*q*u32*2.0;
t356 = N2*t2*u12;
t354 = t352+t353-t356;
t357 = t111*t354*2.0;
t358 = t134*t351*2.0;
t360 = t110*t348*2.0;
t359 = t357+t358-t360;
t361 = N3*u21;
t362 = N3*t2*u21;
t363 = t361+t362;
t364 = N3*u11;
t365 = N3*q*u31*2.0;
t366 = t300+t302+t330+t331-t339;
t369 = N3*t2*u11;
t367 = t364+t365-t369;
t368 = t26*t363*2.0;
t370 = t27*t367*2.0;
t371 = t50*t366*2.0;
t372 = t368+t370+t371;
t373 = N3*u22;
t374 = N3*t2*u22;
t375 = t373+t374;
t376 = N3*u12;
t377 = N3*q*u32*2.0;
t378 = t318+t320+t346+t347-t355;
t381 = N3*t2*u12;
t379 = t376+t377-t381;
t380 = t110*t375*2.0;
t382 = t111*t379*2.0;
t383 = t134*t378*2.0;
t384 = t380+t382+t383;
f(1) = -t4*t4+r2*t82*t177;
f(2) = -t73*t73+r2*t82*t208;
f(3) = -t83*t83+r2*t82*t229;
f(4) = -t88*t88+r2*t165*t238;
f(5) = -t157*t157+r2*t165*t269;
f(6) = -t166*t166+r2*t165*t290;
f(7) = t173+t174+N3*X11*u21-N3*X21*u11-N2*X11*u31+N2*X31*u11+N1*X21*u31-N1*X31*u21-N3*tx*u21+N2*tx*u31+N3*ty*u11-N1*ty*u31-N2*tz*u11+N1*tz*u21-N2*q*tx*u11*2.0-N2*q*tz*u31*2.0-N3*t2*tx*u21-N2*t2*tx*u31-N3*t2*ty*u11+N1*t2*ty*u31+N2*t2*tz*u11+N1*t2*tz*u21+N2*X11*q*u11*2.0-N1*X21*q*u11*2.0-N3*X21*q*u31*2.0+N2*X31*q*u31*2.0+N3*X11*t2*u21+N3*X21*t2*u11+N2*X11*t2*u31-N2*X31*t2*u11-N1*X21*t2*u31-N1*X31*t2*u21;
f(8) = t234+t235+N3*X12*u22-N3*X22*u12-N2*X12*u32+N2*X32*u12+N1*X22*u32-N1*X32*u22-N3*tx*u22+N2*tx*u32+N3*ty*u12-N1*ty*u32-N2*tz*u12+N1*tz*u22-N2*q*tx*u12*2.0-N2*q*tz*u32*2.0-N3*t2*tx*u22-N2*t2*tx*u32-N3*t2*ty*u12+N1*t2*ty*u32+N2*t2*tz*u12+N1*t2*tz*u22+N2*X12*q*u12*2.0-N1*X22*q*u12*2.0-N3*X22*q*u32*2.0+N2*X32*q*u32*2.0+N3*X12*t2*u22+N3*X22*t2*u12+N2*X12*t2*u32-N2*X32*t2*u12-N1*X22*t2*u32-N1*X32*t2*u22;
J(1) = t4*(N3*q*t26*2.0+N2*q*t50*2.0+N3*t3*t184+N2*t3*t194)*-2.0+r2*t177*t222+r2*t5*t82*(N2*t224+N3*q*u21*2.0)*2.0;
J(2) = t73*(N3*q*t27*2.0+N1*q*t50*2.0+N1*t3*t194-N3*t3*t202)*-2.0+r2*t208*t222+r2*t78*t82*(N1*t224-N3*t231)*2.0;
J(3) = t309*(N1*q*t26*2.0-N2*q*t27*2.0+N1*t3*t184+N2*t3*t202)*2.0+r2*t222*t229+r2*t82*t87*(N2*t231+N1*q*u21*2.0)*2.0;
J(4) = -t15+t16+t24-t25+N2*X11*u11*2.0-N1*X21*u11*2.0-N3*X21*u31*2.0+N2*X31*u31*2.0-N2*tx*u11*2.0+N1*ty*u11*2.0+N3*ty*u31*2.0-N2*tz*u31*2.0-N3*q*tx*u21*2.0-N2*q*tx*u31*2.0+N2*q*tz*u11*2.0+N1*q*tz*u21*2.0+N3*X11*q*u21*2.0+N2*X11*q*u31*2.0-N2*X31*q*u11*2.0-N1*X31*q*u21*2.0;
J(5) = t88*(N3*q*t110*2.0+N2*q*t134*2.0+N3*t3*t245+N2*t3*t255)*-2.0+r2*t238*t283+r2*t89*t165*(N2*t285+N3*q*u22*2.0)*2.0;
J(6) = t157*(N3*q*t111*2.0+N1*q*t134*2.0+N1*t3*t255-N3*t3*t263)*-2.0+r2*t269*t283+r2*t161*t165*(N1*t285-N3*t292)*2.0;
J(7) = t327*(N1*q*t110*2.0-N2*q*t111*2.0+N1*t3*t245+N2*t3*t263)*2.0+r2*t283*t290+r2*t165*t170*(N2*t292+N1*q*u22*2.0)*2.0;
J(8) = -t99+t100+t108-t109+N2*X12*u12*2.0-N1*X22*u12*2.0-N3*X22*u32*2.0+N2*X32*u32*2.0-N2*tx*u12*2.0+N1*ty*u12*2.0+N3*ty*u32*2.0-N2*tz*u32*2.0-N3*q*tx*u22*2.0-N2*q*tx*u32*2.0+N2*q*tz*u12*2.0+N1*q*tz*u22*2.0+N3*X12*q*u22*2.0+N2*X12*q*u32*2.0-N2*X32*q*u12*2.0-N1*X32*q*u22*2.0;
J(9) = t4*(N3*t3*t295+N2*t3*t298)*-2.0+r2*t177*t308;
J(10) = t73*(N1*t3*t298-N3*t3*t303)*-2.0+r2*t208*t308;
J(11) = t309*(N1*t3*t295+N2*t3*t303)*2.0+r2*t229*t308;
J(12) = t329-N3*u21-N2*q*u11*2.0-N3*t2*u21-N2*t2*u31;
J(13) = t88*(N3*t3*t313+N2*t3*t316)*-2.0+r2*t238*t326;
J(14) = t157*(N1*t3*t316-N3*t3*t321)*-2.0+r2*t269*t326;
J(15) = t327*(N1*t3*t313+N2*t3*t321)*2.0+r2*t290*t326;
J(16) = t345-N3*u22-N2*q*u12*2.0-N3*t2*u22-N2*t2*u32;
J(17) = t4*(N3*t3*t332-N2*t3*t335)*2.0+r2*t177*t343;
J(18) = t73*(N1*t3*t335+N3*t3*t338)*-2.0+r2*t208*t343;
J(19) = t309*(N1*t3*t332+N2*t3*t338)*-2.0+r2*t229*t343;
J(20) = t296+t297-t299+t364+t365-N3*t2*u11;
J(21) = t88*(N3*t3*t348-N2*t3*t351)*2.0+r2*t238*t359;
J(22) = t157*(N1*t3*t351+N3*t3*t354)*-2.0+r2*t269*t359;
J(23) = t327*(N1*t3*t348+N2*t3*t354)*-2.0+r2*t290*t359;
J(24) = t314+t315-t317+t376+t377-N3*t2*u12;
J(25) = t4*(N3*t3*t363+N2*t3*t366)*-2.0+r2*t177*t372;
J(26) = t73*(N1*t3*t366+N3*t3*t367)*-2.0+r2*t208*t372;
J(27) = t309*(N1*t3*t363-N2*t3*t367)*2.0+r2*t229*t372;
J(28) = t293+t294-t336-t337+t340;
J(29) = t88*(N3*t3*t375+N2*t3*t378)*-2.0+r2*t238*t384;
J(30) = t157*(N1*t3*t378+N3*t3*t379)*-2.0+r2*t269*t384;
J(31) = t327*(N1*t3*t375-N2*t3*t379)*2.0+r2*t290*t384;
J(32) = t311+t312-t352-t353+t356;



